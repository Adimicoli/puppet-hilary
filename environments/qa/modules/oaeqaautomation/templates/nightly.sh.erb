#!/bin/sh

echo "" >> /var/log/nightly.log
echo "" >> /var/log/nightly.log
echo "" >> /var/log/nightly.log
echo "Nightly Run: `date`" >> /var/log/nightly.log
echo "=========================================================" >> /var/log/nightly.log
echo "" >> /var/log/nightly.log

echo "Shutting down services..." >> /var/log/nightly.log
<%= scripts_dir %>/shutdown.sh >> /var/log/nightly.log 2>> /var/log/nightly.log

echo "" >> /var/log/nightly.log
echo "Deleting data..." >> /var/log/nightly.log
<%= scripts_dir %>/deletedata.sh >> /var/log/nightly.log 2>> /var/log/nightly.log

echo "" >> /var/log/nightly.log
echo "Restoring data..." >> /var/log/nightly.log
<%= scripts_dir %>/restoredata.sh >> /var/log/nightly.log 2>> /var/log/nightly.log

echo "" >> /var/log/nightly.log
echo "Restoring services with puppet" >> /var/log/nightly.log
puppet agent -t >> /var/log/nightly.log 2>> /var/log/nightly.log

echo "" >> /var/log/nightly.log
echo "Sleeping to let the app server start up" >> /var/log/nightly.log
sleep 10

echo "" >> /var/log/nightly.log
echo "Re-building search index" >> /var/log/nightly.log

ADMIN_COOKIE=$(curl -s -e "/" --cookie-jar - -d"username=administrator" -d"password=administrator" http://<%= admin_host %>/api/auth/login | grep connect.sess | cut -f 7)
curl -XPOST -e "/" --cookie connect.sess=${ADMIN_COOKIE} http://<%= admin_host%>/api/search/reindexAll  >> /var/log/nightly.log 2>> /var/log/nightly.log