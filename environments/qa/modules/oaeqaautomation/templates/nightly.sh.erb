#!/bin/sh

PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games

echo ""
echo ""
echo ""
echo "Nightly Run: `date`"
echo "========================================================="
echo ""

echo "Shutting down services..."
<%= scripts_dir %>/shutdown.sh

echo ""
echo "Deleting data..."
<%= scripts_dir %>/deletedata.sh

echo ""
echo "Restoring data..."
<%= scripts_dir %>/restoredata.sh

echo ""
echo "Restoring services with puppet"
puppet agent -t


echo ""
echo "Performing production build (this will take a little while)"

service hilary stop

cd <%= ux_root_dir %>
npm install -d
npm install -g grunt-cli
grunt
mv target/optimized /tmp/3akai-ux-optimized
rm -rf <%= ux_root_dir %>
mv /tmp/3akai-ux-optimized <%= ux_root_dir %>

service hilary start

$DELAY=10

echo ""
echo "Sleeping ${DELAY}s to let the app server start up"
sleep $DELAY

echo ""
echo "Re-building search index"

ADMIN_COOKIE=$(curl -s -e "/" --cookie-jar - -d"username=administrator" -d"password=administrator" http://<%= admin_host %>/api/auth/login | grep connect.sess | cut -f 7)
curl -XPOST -e "/" --cookie connect.sess=${ADMIN_COOKIE} http://<%= admin_host%>/api/search/reindexAll