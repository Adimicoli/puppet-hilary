user                    <%= owner %> <%= group %>;
worker_processes        5;
worker_rlimit_nofile    8192;

pid         /var/run/nginx.pid;
lock_file   /var/run/nginx.lock;

events {
  worker_connections    4096;
}

http {
    include <%= nginx_mimes_path %>;

    # Allows us to have "server_name" strings up to 32 characters
    server_names_hash_bucket_size  64;

    # When the back-end server returns a 502, look to the next upstream server
    proxy_next_upstream error timeout http_502;

    # Limit requests per second per remote address
    limit_req_zone          $binary_remote_addr  zone=addr_api:10m  rate=90r/s;
    limit_req_log_level     error;

    ####################
    ## LOAD BALANCING ##
    ####################

    upstream globaladminworkers {
<% internal_app_ips.each do |ip| -%>
        server <%= ip %>:2000;
<% end -%>
    }

    upstream tenantworkers {
<% internal_app_ips.each do |ip| -%>
        server <%= ip %>:2001;
<% end -%>

        keepalive 64;
    }


    # Include all the host-specific configs
    include <%= nginx_conf_dir %>/*.conf
}
