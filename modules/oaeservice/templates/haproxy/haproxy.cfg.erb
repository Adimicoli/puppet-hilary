global
    log               <%= scope['::oaeservice::haproxy::syslog_ip'] %> local0
    log-send-hostname <%= scope['::clientcert'] %>

defaults
    log     global
    mode    tcp
    timeout client 1h
    timeout server 1h
    timeout connect 5s

listen redis_app :<%= scope['::oaeservice::haproxy::cache_port'] %>
    option tcplog
    option logasap
    server  cache-master    <%= scope['::oaeservice::haproxy::cache_master'] %>:6379  check inter 1000 downinter 365d
<% if scope['::oaeservice::haproxy::cache_slave'] -%>
    server  cache-slave     <%= scope['::oaeservice::haproxy::cache_slave'] %>:6379   check inter 1000 downinter 365d backup
<% end -%>

<% if scope['::oaeservice::haproxy::activity_cache_enabled'] -%>
listen redis_activity :<%= scope['::oaeservice::haproxy::activity_cache_port'] %>
    option tcplog
    option logasap
    server  activity-cache-master   <%= scope['::oaeservice::haproxy::activity_cache_master'] %>:6379   check inter 1000 downinter 365d
<% if scope['::oaeservice::haproxy::activity_cache_slave'] -%>
    server  activity-cache-slave    <%= scope['::oaeservice::haproxy::activity_cache_slave'] %>:6379    check inter 1000 downinter 365d backup
<% end -%>
<% end -%>

listen stats :80
    mode http
    stats enable
    stats scope redis_app
    <% if scope['::oaeservice::haproxy::activity_cache_enabled'] -%>stats scope redis_activity<% end -%>
    stats realm HAProxy\ Statistics
    stats uri /
    stats auth haproxy:haproxy
